<!DOCTYPE HTML>
<html>
	<head>
		<title>Financial Goals - OakLedger</title>
		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
		<link rel="stylesheet" href="{{ url_for('static', filename='css/main.css') }}" />
		<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.3.0/css/all.min.css" crossorigin="anonymous" />
		<noscript><link rel="stylesheet" href="{{ url_for('static', filename='css/noscript.css') }}" /></noscript>
        <style>
            .progress-container {
                margin: 20px 0;
                width: 100%;
            }
            .progress-bar {
                height: 20px;
                background-color: #f0f0f0;
                border-radius: 10px;
                overflow: hidden;
                margin: 15px 0 5px;
                position: relative;
                box-shadow: inset 0 1px 3px rgba(0,0,0,0.2);
            }
            .progress-fill {
                height: 100%;
                background: linear-gradient(90deg, #4CAF50, #45a049);
                transition: width 0.5s ease-in-out;
                min-width: 2%;
                border-radius: 10px;
                position: relative;
                overflow: hidden;
            }
            .progress-fill::after {
                content: '';
                position: absolute;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: linear-gradient(
                    -45deg,
                    rgba(255, 255, 255, 0.2) 25%,
                    transparent 25%,
                    transparent 50%,
                    rgba(255, 255, 255, 0.2) 50%,
                    rgba(255, 255, 255, 0.2) 75%,
                    transparent 75%,
                    transparent
                );
                background-size: 30px 30px;
                animation: move 2s linear infinite;
                border-radius: 10px;
            }
            @keyframes move {
                0% { background-position: 0 0; }
                100% { background-position: 30px 30px; }
            }
            .milestones {
                display: flex;
                justify-content: space-between;
                margin: 15px 0 25px;
                position: relative;
                padding: 0 15px;
                background: #ffffff;
                padding: 15px;
                border-radius: 10px;
                box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            }
            .milestones::before {
                content: '';
                position: absolute;
                top: 25px;
                left: 50px;
                right: 50px;
                height: 4px;
                background: #f0f0f0;
                z-index: 0;
                border-radius: 2px;
            }
            .milestone {
                display: flex;
                flex-direction: column;
                align-items: center;
                z-index: 1;
                background: transparent;
                padding: 5px 15px;
                position: relative;
            }
            .milestone .dot {
                width: 28px;
                height: 28px;
                border-radius: 50%;
                background-color: #f8f9fa;
                display: flex;
                align-items: center;
                justify-content: center;
                margin-bottom: 5px;
                font-weight: bold;
                font-size: 11px;
                box-shadow: 0 2px 6px rgba(0,0,0,0.1);
                transition: all 0.3s ease;
                border: 2px solid #e9ecef;
                color: #6c757d;
                line-height: 1;
            }
            /* 25% - Blue */
            .milestone[data-percent="25"] .dot {
                border-color: #4e79a7;
                color: #4e79a7;
            }
            .milestone[data-percent="25"].achieved .dot {
                background-color: #4e79a7;
                color: white;
                box-shadow: 0 4px 8px rgba(78, 121, 167, 0.3);
            }
            /* 50% - Teal */
            .milestone[data-percent="50"] .dot {
                border-color: #59a14f;
                color: #59a14f;
            }
            .milestone[data-percent="50"].achieved .dot {
                background-color: #59a14f;
                color: white;
                box-shadow: 0 4px 8px rgba(89, 161, 79, 0.3);
            }
            /* 75% - Orange */
            .milestone[data-percent="75"] .dot {
                border-color: #f28e2b;
                color: #f28e2b;
            }
            .milestone[data-percent="75"].achieved .dot {
                background-color: #f28e2b;
                color: white;
                box-shadow: 0 4px 8px rgba(242, 142, 43, 0.3);
            }
            /* 100% - Green */
            .milestone[data-percent="100"] .dot {
                border-color: #4CAF50;
                color: #4CAF50;
            }
            .milestone[data-percent="100"].achieved .dot {
                background: linear-gradient(135deg, #4CAF50, #45a049);
                color: white;
                box-shadow: 0 4px 12px rgba(76, 175, 80, 0.4);
                transform: scale(1.1);
            }
            .milestone .label {
                font-size: 12px;
                color: #666;
                margin-top: 5px;
            }
            .goal-stats {
                background: #f9f9f9;
                border-radius: 8px;
                padding: 15px;
                margin: 15px 0;
                border: 1px solid #eee;
            }
            .goal-stats p {
                margin: 8px 0;
                font-size: 15px;
                color: #444;
            }
        </style>
	</head>
	<body class="is-preload">
		<!-- Wrapper -->
			<div id="wrapper">
				{% include 'header.html' %}

				<!-- Main -->
					<div id="main">
						<div class="inner">
							<header>
								<h1>Financial Goals</h1>
								<p>Set and track your financial goals</p>
							</header>

							<!-- Sample Profiles for Goals -->
							<section>
								<div class="box" style="margin-bottom: 2em;">
									<h3>Try a Sample Profile:</h3>
									<p>Click to auto-fill the goal form with example data.</p>
									<div class="row">
										<div class="col-4">
											<a href="#" class="button sample-profile" data-profile="young_professional" style="width: 100%;">Young Professional</a>
										</div>
										<div class="col-4">
											<a href="#" class="button sample-profile" data-profile="family_of_four" style="width: 100%;">Family of Four</a>
										</div>
										<div class="col-4">
											<a href="#" class="button sample-profile" data-profile="retired_couple" style="width: 100%;">Retired Couple</a>
										</div>
									</div>
								</div>
							</section>

                            <!-- New Goal Form -->
                            <section>
                                <div class="box">
                                    <h3>Create New Goal</h3>
                                    <form method="post" action="{{ url_for('goals') }}">
                                        <div class="row gtr-uniform">
                                            <div class="col-6 col-12-xsmall">
                                                <label for="goal_name">Goal Name</label>
                                                <input type="text" name="goal_name" id="goal_name" placeholder="e.g., Emergency Fund" required />
                                            </div>
                                            <div class="col-6 col-12-xsmall">
                                                <label for="target_amount">Target Amount (INR ₹)</label>
                                                <input type="number" name="target_amount" id="target_amount" placeholder="Enter target amount (₹)" required min="0" step="0.01" />
                                            </div>
                                            <div class="col-6 col-12-xsmall">
                                                <label for="current_amount">Current Amount Saved (INR ₹)</label>
                                                <input type="number" name="current_amount" id="current_amount" placeholder="Enter current savings (₹)" required min="0" step="0.01" />
                                            </div>
                                            <div class="col-6 col-12-xsmall">
                                                <label for="target_date">Target Date (Optional)</label>
                                                <input type="date" name="target_date" id="target_date" />
                                            </div>
                                            <div class="col-12">
                                                <ul class="actions">
                                                    <li><input type="submit" value="Create Goal" class="primary" /></li>
                                                </ul>
                                            </div>
                                        </div>
                                    </form>
                                </div>
                            </section>

                            <!-- Existing Goals -->
                            <section>
                                {% if goals %}
                                    <div class="box" style="margin-bottom: 1.5rem;">
                                        <form method="post" action="{{ url_for('goals') }}">
                                            <input type="hidden" name="action" value="clear" />
                                            <ul class="actions">
                                                <li><input type="submit" value="Clear All Goals" class="button" /></li>
                                            </ul>
                                        </form>
                                    </div>
                                    {% for goal in goals %}
                                        <div class="box">
                                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                                <h3>{{ goal.name }}</h3>
                                                <div>
                                                    <button class="button small edit-goal" data-goal-id="{{ loop.index0 }}">Edit</button>
                                                </div>
                                            </div>
                                            <div data-target-amount="{{ goal.target_amount }}" data-current-amount="{{ goal.current_amount|default(0) }}" data-time-frame="{{ goal.time_frame|default(12) }}" style="display: none;"></div>
                                            <div class="progress-container">
                                                <!-- Progress Bar -->
                                                <div class="progress-bar">
                                                    <div class="progress-fill" 
                                                     data-progress="{{ goal.progress.progress_percentage|default(0) }}">
                                                </div>
                                                </div>
                                                
                                                <!-- Milestones -->
                                                <div class="milestones">
                                                    {% for milestone in goal.progress.milestones %}
                                                        <div class="milestone {% if milestone.achieved %}achieved{% endif %}" data-percent="{{ milestone.percentage }}">
                                                            <div class="dot">{{ milestone.percentage }}%</div>
                                                            <span class="label">
                                                                {% if milestone.percentage == 25 %}Start
                                                                {% elif milestone.percentage == 50 %}Halfway
                                                                {% elif milestone.percentage == 75 %}Almost
                                                                {% else %}Complete{% endif %}
                                                            </span>
                                                        </div>
                                                    {% endfor %}
                                                </div>
                                            </div>
                                            
                                            <div class="goal-stats">
                                                <p><strong>Target Amount:</strong> ₹{{ "%.2f"|format(goal.target_amount) }}</p>
                                                <p><strong>Current Savings:</strong> ₹{{ "%.2f"|format(goal.get('current_amount', 0)) }}</p>
                                                <p><strong>Progress:</strong> {{ "%.1f"|format(goal.progress.progress_percentage) }}%</p>
                                                {% if goal.target_date %}
                                                    {% set days_remaining = goal.progress.days_remaining|default(0) %}
                                                    <p><strong>Time Remaining:</strong> 
                                                        {% if days_remaining > 30 %}
                                                            {{ (days_remaining/30)|round(1) }} months
                                                        {% else %}
                                                            {{ days_remaining|int }} days
                                                        {% endif %}
                                                    </p>
                                                {% endif %}
                                            </div>
                                            </div>
                                            
                                            {% if goal.get('analysis', {}).get('recommendations') %}
                                                <div class="recommendations">
                                                    <h4>Recommendations:</h4>
                                                    <ul>
                                                        {% for rec in goal.analysis.recommendations %}
                                                            <li>{{ rec }}</li>
                                                        {% endfor %}
                                                    </ul>
                                                </div>
                                            {% endif %}
                                        </div>
                                    {% endfor %}
                                {% else %}
                                    <div class="box">
                                        <p>No goals set yet. Create your first goal above!</p>
                                    </div>
                                {% endif %}
                            </section>
						</div>
					</div>

				{% include 'footer.html' %}
			</div>

        <!-- Edit Goal Modal -->
        <div id="editGoalModal" class="modal" style="display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(255,255,255,0.9);">
            <div class="modal-content" style="background-color: #2c2c2c; color: #f0f0f0; margin: 10% auto; padding: 25px; border: 1px solid #444; width: 80%; max-width: 600px; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.3);">
                <span class="close" style="color: #bbb; float: right; font-size: 28px; font-weight: bold; cursor: pointer; transition: color 0.3s;">&times;</span>
                <h3>Edit Goal</h3>
                <form id="editGoalForm" method="post" action="{{ url_for('update_goal') }}">
                    <input type="hidden" name="goal_index" id="editGoalIndex">
                    <div class="row gtr-uniform">
                        <div class="col-12">
                            <label for="edit_goal_name" style="color: #f0f0f0;">Goal Name</label>
                            <input type="text" name="goal_name" id="edit_goal_name" required style="background-color: #3a3a3a; color: #ffffff; border: 1px solid #555; padding: 8px; border-radius: 4px; width: 100%;">
                        </div>
                        <div class="col-6 col-12-xsmall">
                            <label for="edit_target_amount" style="color: #f0f0f0;">Target Amount (₹)</label>
                            <input type="number" name="target_amount" id="edit_target_amount" min="0" step="0.01" required style="background-color: #3a3a3a; color: #ffffff; border: 1px solid #555; padding: 8px; border-radius: 4px; width: 100%;">
                        </div>
                        <div class="col-6 col-12-xsmall">
                            <label for="edit_current_amount" style="color: #f0f0f0;">Current Amount (₹)</label>
                            <input type="number" name="current_amount" id="edit_current_amount" min="0" step="0.01" required style="background-color: #3a3a3a; color: #ffffff; border: 1px solid #555; padding: 8px; border-radius: 4px; width: 100%;">
                        </div>
                        <div class="col-12">
                            <label for="edit_time_frame" style="color: #f0f0f0;">Time Frame (months)</label>
                            <input type="number" name="time_frame" id="edit_time_frame" min="1" required style="background-color: #3a3a3a; color: #ffffff; border: 1px solid #555; padding: 8px; border-radius: 4px; width: 100%;">
                        </div>
                        <div class="col-12">
                            <ul class="actions" style="margin-top: 20px;">
                                <li><input type="submit" value="Update Goal" class="primary" style="background-color: #4a6fa5; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer;" /></li>
                                <li><input type="button" value="Cancel" class="button" id="cancelEdit" style="background-color: #555; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; margin-left: 10px;" /></li>
                            </ul>
                        </div>
                    </div>
                </form>
            </div>
        </div>

        <script>
            // Modal functionality
            const modal = document.getElementById('editGoalModal');
            const span = document.getElementsByClassName('close')[0];
            const cancelBtn = document.getElementById('cancelEdit');
            
            // When user clicks on (x), close the modal
            span.onclick = function() {
                modal.style.display = "none";
            }
            
            // Add hover effect for close button
            span.addEventListener('mouseover', function() {
                this.style.color = '#fff';
            });
            
            span.addEventListener('mouseout', function() {
                this.style.color = '#bbb';
            });
            
            // When user clicks on Cancel button, close the modal
            cancelBtn.onclick = function() {
                modal.style.display = "none";
            }
            
            // When user clicks anywhere outside of the modal, close it
            window.onclick = function(event) {
                if (event.target == modal) {
                    modal.style.display = "none";
                }
            }
            
            // Edit goal button click handler
            document.addEventListener('click', function(event) {
                if (event.target && event.target.matches('.edit-goal')) {
                    const goalId = event.target.getAttribute('data-goal-id');
                    
                    // Get goal data from the DOM instead of template
                    const goalCard = event.target.closest('.box');
                    const goalData = {
                        name: goalCard.querySelector('h3').textContent.trim(),
                        target_amount: parseFloat(goalCard.querySelector('[data-target-amount]').dataset.targetAmount),
                        current_amount: parseFloat(goalCard.querySelector('[data-current-amount]').dataset.currentAmount) || 0,
                        time_frame: parseInt(goalCard.querySelector('[data-time-frame]').dataset.timeFrame) || 12
                    };
                    
                    // Populate form with goal data
                    document.getElementById('editGoalIndex').value = goalId;
                    document.getElementById('edit_goal_name').value = goalData.name;
                    document.getElementById('edit_target_amount').value = goalData.target_amount;
                    document.getElementById('edit_current_amount').value = goalData.current_amount;
                    document.getElementById('edit_time_frame').value = goalData.time_frame;
                    
                    // Show modal
                    modal.style.display = "block";
                }
            });

            // Set progress bar widths after page loads
            document.addEventListener('DOMContentLoaded', function() {
                document.querySelectorAll('.progress-fill').forEach(function(progressBar) {
                    const progress = progressBar.getAttribute('data-progress') || 0;
                    progressBar.style.width = progress + '%';
                });
            });
        </script>
        
        <!-- Scripts -->
			<script src="{{ url_for('static', filename='js/jquery.min.js') }}"></script>
			<script src="{{ url_for('static', filename='js/browser.min.js') }}"></script>
			<script src="{{ url_for('static', filename='js/breakpoints.min.js') }}"></script>
			<script src="{{ url_for('static', filename='js/util.js') }}"></script>
			<script src="{{ url_for('static', filename='js/main.js') }}"></script>
			<script>
				document.addEventListener('DOMContentLoaded', function() {
					const sampleButtons = document.querySelectorAll('.sample-profile');
					sampleButtons.forEach(btn => {
						btn.addEventListener('click', function(e) {
							e.preventDefault();
							const profileId = this.dataset.profile;
							fetch(`/load_sample/${profileId}`)
								.then(r => r.json())
								.then(data => {
									if (!data.goal_preset) return;
									document.getElementById('goal_name').value = data.goal_preset.goal_name || '';
									document.getElementById('target_amount').value = data.goal_preset.target_amount || '';
									document.getElementById('current_amount').value = data.goal_preset.current_amount || '';
									if (data.goal_preset.target_date) {
										document.getElementById('target_date').value = data.goal_preset.target_date;
									}
								});
						});
					});
				});
			</script>
	</body>
</html>