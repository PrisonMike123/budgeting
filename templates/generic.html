<!DOCTYPE HTML>
<html>
	<head>
		<title>Your Budget Recommendations</title>
		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
		<link rel="stylesheet" href="{{ url_for('static', filename='css/main.css') }}" />
		<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.3.0/css/all.min.css" integrity="sha512-SzlrxWUlpfuzQ+pcUCosxcglQRNAq/DZjVsC0lE40xsADsfeQoEypE+enwcOiGjk/bSuGGKHEyjSoQ1zVisanQ==" crossorigin="anonymous" referrerpolicy="no-referrer" />
		<noscript><link rel="stylesheet" href="{{ url_for('static', filename='css/noscript.css') }}" /></noscript>
	</head>
	<body class="is-preload">
		<!-- Wrapper -->
			<div id="wrapper">
				{% include 'header.html' %}

				<!-- Main -->
					<div id="main">
						<div class="inner">
							<header>
								<h1>Your Financial Health Analysis</h1>
								<p>Based on your income and expenses, here's a detailed analysis of your financial health:</p>
							</header>
							
							<!-- Financial Health Score -->
							<section>
								<div class="box">
									{% if budget_data.financial_health is defined and budget_data.financial_health is not none %}
										<h2>Financial Health Score: {{ budget_data.financial_health.health_score }}/100</h2>
										<p>Status: <strong>{{ budget_data.financial_health.status }}</strong></p>
										
										<h3>Key Metrics:</h3>
										<ul>
											<li>Savings Rate: {{ "%.1f"|format(budget_data.financial_health.metrics.savings_rate) }}%</li>
											<li>Expense to Income Ratio: {{ "%.1f"|format(budget_data.financial_health.metrics.expense_to_income_ratio) }}%</li>
											<li>Monthly Savings: ₹{{ "%.2f"|format(budget_data.financial_health.metrics.monthly_savings) }}</li>
										</ul>
										
										<h3>Recommendations:</h3>
										<ul>
											{% for rec in budget_data.financial_health.recommendations %}
											<li>
												<strong>{{ rec.category }}</strong> (Priority: {{ rec.priority }})<br>
												{{ rec.suggestion }}
											</li>
											{% endfor %}
										</ul>
									{% else %}
										<h2>Financial Health Analysis</h2>
										<div class="alert alert-info">
											<p>We couldn't calculate your financial health score because we're missing some information.</p>
											<p>Please make sure you've entered both your monthly income and expenses.</p>
										</div>
									{% endif %}
								</div>
							</section>

							<section>
								<!-- User Information -->
								<div class="box">
									<h3>Your Profile</h3>
									<div class="row">
										<div class="col-6 col-12-medium">
											<ul>
												{% if 'monthly_income' in budget_data %}
												<li><strong>Monthly Income:</strong> ₹{{ "%.0f"|format(budget_data.monthly_income) }}</li>
												{% else %}
												<li><strong>Monthly Income:</strong> Not provided</li>
												{% endif %}
												
												{% if 'age_range' in budget_data %}
												<li><strong>Age Range:</strong> {{ budget_data.age_range }}</li>
												{% else %}
												<li><strong>Age Range:</strong> Not provided</li>
												{% endif %}
											</ul>
										</div>
										<div class="col-6 col-12-medium">
											<ul>
												{% if 'family_size' in budget_data %}
												<li><strong>Family Size:</strong> {{ budget_data.family_size }}</li>
												{% else %}
												<li><strong>Family Size:</strong> Not provided</li>
												{% endif %}
												
												{% if 'location' in budget_data %}
												<li><strong>Location:</strong> {{ budget_data.location }}</li>
												{% else %}
												<li><strong>Location:</strong> Not provided</li>
												{% endif %}
											</ul>
										</div>
									</div>
								</div>

								<!-- Pie Chart -->
								{% if chart_data %}
								<div style="text-align: center; margin: 2rem 0;">
									<h3>Budget Allocation</h3>
									<canvas id="budgetChart" width="400" height="400" style="max-width: 500px; max-height: 500px;"></canvas>
								</div>
								{% endif %}

								<!-- Budget Details Table -->
								{% if recommendations %}
								<div class="table-wrapper">
									<h3>Detailed Breakdown</h3>
									<table>
										<thead>
											<tr>
												<th>Category</th>
												<th>Percentage</th>
												<th>Amount (₹)</th>
											</tr>
										</thead>
										<tbody>
											{% for category, data in recommendations.items() %}
											<tr>
												<td>{{ category }}</td>
												<td>{{ data.display_percentage }}</td>
												<td>{{ data.display_amount }}</td>
											</tr>
											{% endfor %}
										</tbody>
										<tfoot>
											<tr>
												<td><strong>Total</strong></td>
												<td><strong>100%</strong></td>
												<td><strong>{% if 'monthly_income' in budget_data %}₹{{ "%.0f"|format(budget_data.monthly_income) }}{% else %}N/A{% endif %}</strong></td>
											</tr>
										</tfoot>
									</table>
								</div>
								{% endif %}

								<!-- Action Buttons -->
								<div class="row" style="margin-top: 2rem;">
									<div class="col-6">
										<ul class="actions">
											<li><a href="{{ url_for('index') }}" class="button primary">Modify Budget</a></li>
										</ul>
									</div>
									<div class="col-6">
										<ul class="actions">
											<li><a href="{{ url_for('download_csv') }}" class="button">Download CSV Report</a></li>
										</ul>
									</div>
								</div>
							</section>
						</div>
					</div>

				<!-- ML Prediction Section -->
<section class="ml-prediction">
    <h2>AI-Powered Financial Health Prediction</h2>
    <div class="prediction-result" id="mlPredictionResult">
        <p>Loading predictions...</p>
    </div>
</section>

{% include 'footer.html' %}
			</div>

		<!-- Scripts -->
			<script src="{{ url_for('static', filename='js/jquery.min.js') }}"></script>
			<script src="{{ url_for('static', filename='js/browser.min.js') }}"></script>
			<script src="{{ url_for('static', filename='js/breakpoints.min.js') }}"></script>
			<script src="{{ url_for('static', filename='js/util.js') }}"></script>
			<script src="{{ url_for('static', filename='js/main.js') }}"></script>
<script>
// Function to load ML predictions
function loadMLPredictions() {
    // Get the current form data with safe defaults
    const formData = {
        total_income: parseFloat('{{ (budget_data.income.total_income if budget_data and budget_data.income and budget_data.income.total_income is defined else 0) | default(0) }}') || 0,
        total_expenses: parseFloat('{{ (budget_data.expenses.total_expenses if budget_data and budget_data.expenses and budget_data.expenses.total_expenses is defined else 0) | default(0) }}') || 0,
        savings: parseFloat('{{ (budget_data.savings.total_savings if budget_data and budget_data.savings and budget_data.savings.total_savings is defined else 0) | default(0) }}') || 0,
        age: parseFloat('{{ (budget_data.personal_info.age if budget_data and budget_data.personal_info and budget_data.personal_info.age is defined else 30) | default(30) }}') || 30,
        family_size: parseFloat('{{ (budget_data.personal_info.family_size if budget_data and budget_data.personal_info and budget_data.personal_info.family_size is defined else 1) | default(1) }}') || 1,
        credit_rating: parseFloat('{{ (budget_data.credit_info.credit_score if budget_data and budget_data.credit_info and budget_data.credit_info.credit_score is defined else 700) | default(700) }}') || 700
    };

    // Calculate ratios if possible
    if (formData.total_income > 0) {
        formData.expense_ratio = formData.total_expenses / formData.total_income;
        formData.savings_ratio = formData.savings / formData.total_income;
        formData.debt_ratio = (formData.total_expenses * 0.3) / formData.total_income; // Simplified debt ratio
    }

    // Make the API call
    fetch('/api/predict', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(formData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            const result = data.data;
            const resultHtml = `
                <div class="prediction-card">
                    <h3>AI Analysis Results</h3>
                    <div class="prediction-metric">
                        <span class="metric-label">Financial Health:</span>
                        <span class="metric-value ${result.financial_health.toLowerCase()}">${result.financial_health}</span>
                    </div>
                    <div class="prediction-metric">
                        <span class="metric-label">Predicted Monthly Expense:</span>
                        <span class="metric-value">$${result.predicted_expense.toLocaleString()}</span>
                    </div>
                    <div class="prediction-tip">
                        <i class="fas fa-lightbulb"></i> ${result.savings_recommendation}
                    </div>
                </div>
            `;
            document.getElementById('mlPredictionResult').innerHTML = resultHtml;
        } else {
            document.getElementById('mlPredictionResult').innerHTML = 
                '<p class="error">Could not load predictions. Please try again later.</p>';
        }
    })
    .catch(error => {
        console.error('Error:', error);
        document.getElementById('mlPredictionResult').innerHTML = 
            '<p class="error">Error loading predictions. Please check your connection.</p>';
    });
}

// Load predictions when the page loads
document.addEventListener('DOMContentLoaded', loadMLPredictions);
</script>

		<!-- Chart.js -->
		<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
		<script>
		document.addEventListener('DOMContentLoaded', function() {
			const chartData = JSON.parse('{{ chart_data|tojson|safe }}');

			if (chartData) {
				const ctx = document.getElementById('budgetChart').getContext('2d');
				new Chart(ctx, {
					type: 'pie',
					data: {
						labels: chartData.labels,
						datasets: [{
							data: chartData.percentages,
							backgroundColor: chartData.colors,
							borderWidth: 2,
							borderColor: '#ffffff'
						}]
					},
					options: {
						responsive: true,
						plugins: {
							legend: {
								position: 'right',
								labels: {
									color: '#e5e7eb',
									font: { size: 11 },
									padding: 15
								}
							},
							tooltip: {
								backgroundColor: '#111',
								borderColor: '#333',
								borderWidth: 1,
								titleColor: '#e5e7eb',
								bodyColor: '#e5e7eb',
								callbacks: {
									label: function(context) {
										const label = context.label || '';
										const value = context.parsed;
										const amount = chartData.amounts[context.dataIndex];
										return `${label}: ${value.toFixed(1)}% (₹${amount.toLocaleString('en-IN')})`;
									}
								}
							}
						}
					}
				});
			}
		});
		</script>
	</body>
</html>
